<?php
$startTime = hrtime(true);
ini_set('display_errors', 1); 
error_reporting(E_ALL);
require '/var/www/mysite/common/database.php';
require '/var/www/mysite/common/helper.php';
require '/var/www/mysite/dbinsert/insertdata.php';
require '/var/www/mysite/dbread/reportdata.php';

$echoResponse=array();
$traceMessage = "";
$resultData = "";
$responseArray = array();
fillResponseArray();
$debugMessage = "";
$fatalFlag = false;
$action = "INS";
$prevAction = "";
$src = "SCRIPT";
$scriptVersion = "1.0";

$envoyDateEpoch = 0;
$envoyDateYYYYMM = "";
$dateYYYYMM = "";
$envoyLifeTimeProdRaw = 0;
$envoyLifeTimeConsRaw = 0;
$envoyLifeTimeNetRaw = 0;
$envoyCurrMonthProd = 0;
$envoyCurrMonthCons = 0;
$envoyCurrMonthNet = 0;
$YTDLifeTimeProdRaw = 0;
$YTDLifeTimeConsRaw = 0;
$YTDLifeTimeNetRaw = 0;
$YTDCurrMonthProd = 0;
$YTDCurrMonthCons = 0;
$YTDCurrMonthNet = 0;

$echoResponse["version"] = $scriptVersion;
if (isset($_GET['action']))
    $action = testinput($_GET['action']);

if (isset($_GET['src']))
    $src = testinput($_GET['src']);

    if (isset($_GET['date']))
    $dateYYYYMM = testinput($_GET['date']);
    
$conn = new mysqli($servername, $username, $password, $dbname);
// Check connection
if ($conn->connect_error)
{
  	die("Connection failed: " . $conn->connect_error);
    $echoResponse["result"] = "FATAL";
    $echoResponse["message"] = $responseArray["0"];
    $echoResponse["processTime"] = round((hrtime(true) - $startTime)/1e+6,2)."ms";
    echo json_encode($echoResponse);
    exit();
}
else
{
    $conn->autocommit(TRUE);
    
    $currMonthSelQuery = "SELECT NetMeterYYYYMM, LifeTimeProdRaw, LifeTimeConsRaw, LifeTimeNetRaw, CurrMonthProd, CurrMonthCons, CurrMonthNet FROM EnvoyMonthlyReadings WHERE NetMeterYYYYMM <= ? ORDER BY NetMeterYYYYMM DESC LIMIT 0,1";
    $currMonthSelStmt = $conn->prepare($currMonthSelQuery);

    $prevMonthSelQuery = "SELECT NetMeterYYYYMM, LifeTimeProdRaw, LifeTimeConsRaw, LifeTimeNetRaw, CurrMonthProd, CurrMonthCons, CurrMonthNet FROM EnvoyMonthlyReadings WHERE NetMeterYYYYMM <= ? ORDER BY NetMeterYYYYMM DESC LIMIT 1,1";
    $prevMonthSelStmt = $conn->prepare($prevMonthSelQuery);
    
    $currentInsUpdQuery = "REPLACE INTO EnvoyMonthlyReadings SET NetMeterYYYYMM = ?, LifeTimeProdRaw = ?,LifeTimeConsRaw = ?,LifeTimeNetRaw = ?,CurrMonthProd = ?,CurrMonthCons = ?,CurrMonthNet = ?;";
    $currentInsUpdStmt = $conn->prepare($currentInsUpdQuery);

    $echoResponse["trace"] = "";
    $echoResponse["resultData"] = "";
}

if($action != "INS" && $action != "REP")
{
    $echoResponse["result"] = "FATAL";
    $echoResponse["message"] = $responseArray["-98"];
    $echoResponse["processTime"] = round((hrtime(true) - $startTime)/1e+6,2)."ms";
    echo json_encode($echoResponse);
    exit();
}

if($action == "REP")
{
    if($dateYYYYMM == "")
    {
        $echoResponse["result"] = "FATAL";
        $echoResponse["message"] = $responseArray["-98"];
        $echoResponse["processTime"] = round((hrtime(true) - $startTime)/1e+6,2)."ms";
        echo json_encode($echoResponse);
        exit();        
    }
    if($currMonthSelStmt->bind_param("s",$dateYYYYMM))
    {
        $currMonthSelStmt->execute();
        $result = $currMonthSelStmt->get_result();
        if (mysqli_num_rows($result) > 0)
        {
            while ($row = $result->fetch_assoc())
            {
                $YTDLifeTimeProdRaw = $row["LifeTimeProdRaw"];
                $YTDLifeTimeConsRaw = $row["LifeTimeConsRaw"];
                $YTDLifeTimeNetRaw = $row["LifeTimeNetRaw"];
                $YTDCurrMonthProd = $row["CurrMonthProd"];
                $YTDCurrMonthCons = $row["CurrMonthCons"];
                $YTDCurrMonthNet = $row["CurrMonthNet"];  
            }
        }
        else
        {
            $echoResponse["result"] = "NoData";
            $echoResponse["message"] = $responseArray["10"];
            $echoResponse["processTime"] = round((hrtime(true) - $startTime)/1e+6,2)."ms";
            echo json_encode($echoResponse);
            exit(); 
        }
    }
}
if($action == "INS")
{
    $envoyURL = "http://envoy.local/production.json";
    $envoyData = json_decode(file_get_contents($envoyURL));
    $envoyDateEpoch = $envoyData->consumption[0]->readingTime;
    $envoyLifeTimeProdRaw = $envoyData->production[1].whLifetime;
    $envoyLifeTimeConsRaw = $envoyData->consumption[0].whLifetime;
    $envoyLifeTimeNetRaw = $envoyData->consumption[1].whLifetime;

    if ($envoyDateEpoch == 0)
    {
        $echoResponse["result"] = "NoData";
        $echoResponse["message"] = $responseArray["10"];
        $echoResponse["processTime"] = round((hrtime(true) - $startTime)/1e+6,2)."ms";
        echo json_encode($echoResponse);
        exit();   
    }
    $envoyDateYYYYMM = YYYYMMFromEpoch($envoyData->consumption[0]->readingTime);
    
    if($currMonthSelStmt->bind_param("s",$envoyDateYYYYMM))
    {
        $currMonthSelStmt->execute(); 
        $result = $currMonthSelStmt->get_result();
        if (mysqli_num_rows($result) == 0)
        {
            if($prevMonthSelStmt->bind_param("s",$envoyDateYYYYMM))
            {
                $result = $prevMonthSelStmt->get_result();
                if (mysqli_num_rows($result) == 0)
                {
                    $YTDLifeTimeProdRaw = $envoyLifeTimeProdRaw;
                    $YTDLifeTimeConsRaw = $envoyLifeTimeConsRaw;
                    $YTDLifeTimeNetRaw = $envoyLifeTimeNetRaw;
                    $YTDCurrMonthProd = $YTDCurrMonthCons = $YTDCurrMonthNet = 0;  
                }
                else
                {
                    while ($row = $result->fetch_assoc())
                    {
                        $YTDLifeTimeProdRaw = $row["LifeTimeProdRaw"];
                        $YTDLifeTimeConsRaw = $row["LifeTimeConsRaw"];
                        $YTDLifeTimeNetRaw = $row["LifeTimeNetRaw"];
                        $YTDCurrMonthProd = $row["CurrMonthProd"];
                        $YTDCurrMonthCons = $row["CurrMonthCons"];
                        $YTDCurrMonthNet = $row["CurrMonthNet"];  
                    }   
                }
            }    
        }
        else
        {
            while ($row = $result->fetch_assoc())
            {
                $YTDLifeTimeProdRaw = $row["LifeTimeProdRaw"];
                $YTDLifeTimeConsRaw = $row["LifeTimeConsRaw"];
                $YTDLifeTimeNetRaw = $row["LifeTimeNetRaw"];
                $YTDCurrMonthProd = $row["CurrMonthProd"];
                $YTDCurrMonthCons = $row["CurrMonthCons"];
                $YTDCurrMonthNet = $row["CurrMonthNet"];  
            }
        }
        $YTDCurrMonthProd = $YTDCurrMonthProd + $envoyLifeTimeProdRaw - $YTDLifeTimeProdRaw;
        $YTDCurrMonthCons = $YTDCurrMonthCons + $envoyLifeTimeConsRaw - $YTDLifeTimeConsRaw;
        $YTDCurrMonthNet  = $YTDCurrMonthNet  + $envoyLifeTimeNetRaw  - $YTDLifeTimeNetRaw;
    }
}



$envoyDateYYYYMM = YYYYMMFromEpoch($envoyData->consumption[0]->readingTime);
if($latestSelStmt->bind_param("s",$envoyDateYYYYMM))
{
    $latestSelStmt->execute();
    $result = $latestSelStmt->get_result();
    if (mysqli_num_rows($result) > 0)
    {
        while ($row = $result->fetch_assoc())
        {
            $YTDLifeTimeProdRaw = $row["LifeTimeProdRaw"];
            $YTDLifeTimeConsRaw = $row["LifeTimeConsRaw"];
            $YTDLifeTimeNetRaw = $row["LifeTimeNetRaw"];
            $YTDCurrMonthProd = $row["CurrMonthProd"];
            $YTDCurrMonthCons = $row["CurrMonthCons"];
            $YTDCurrMonthNet = $row["CurrMonthNet"];  
        }
    }
}
if($action == "REP")
{

}

if($action == "INS")
{
    $envoyLifeTimeProdRaw = $envoyData->production[1].whLifetime;
    $envoyLifeTimeConsRaw = $envoyData->consumption[0].whLifetime;
    $envoyLifeTimeNetRaw = $envoyData->consumption[1].whLifetime;
}



fetchEnvoyHourlyData();
if ($envoyDateEpoch == 0 && $action == "REP")
{
    $echoResponse["result"] = "NoData";
    $echoResponse["message"] = $responseArray["10"];
}
else
{
    if($action == "INS" && $src == "SCRIPT")
        insertLocalEnvoyHourlyData();
    
    $retryCount = 0;
    while(true)
    {
        fetchEnvoyHourlyData();
        if ($envoyDateEpoch != 0 || $retryCount > 5 )
            break;
        $retryCount++;
    }    
    $echoResponse["envoyHourlyReadingDate"] = $envoyDate;
    $echoResponse["envoyHourlyReadingDateTime"] = dMYHiFromEpoch($envoyDateEpoch);
    $echoResponse["envoyProductionPrevHour"] = sprintf("%05.2f",$envoyProductionPrevHour);
    $echoResponse["envoyConsumptionPrevHour"] = sprintf("%05.2f",$envoyConsumptionPrevHour);
    $echoResponse["envoyProductionDay"] = sprintf("%05.2f",$envoyProductionDayPrevHour);
    $echoResponse["envoyConsumptionDay"] = sprintf("%05.2f",$envoyConsumptionDayPrevHour);
    $echoResponse["result"] = "OK";
    if($prevAction == "INS" && $action == "REP")
        $echoResponse["message"] = $responseArray["8"];
    else
        $echoResponse["message"] = $responseArray["9"];
}
//$envoyDateEpoch = YYYYMMDDFromEpoch(time());
$rowCount = 0;
$currMaxProd = $currMinProd = $currMaxCons = $currMinCons  = 0.00;
$currMaxProdTime = $currMinProdTime = $currMaxConsTime = $currMinConsTime = "";
$maxMinDate = $envoyDate;
if(hhFromEpoch(time()) == 00 && mmFromEpoch(time() == 00))
{
    $maxMinDate = prevDays(1);
}

if($maxminStmt->bind_param("s",$maxMinDate))
{
    $maxminStmt->execute();
    $result = $maxminStmt->get_result();
    $rowCount = mysqli_num_rows($result);
    if($rowCount > 0)
    {
        while ($row = $result->fetch_assoc())
        {
            $currMaxProd = $row["ProductionMax"];
            $currMaxProdTime = $row["ProductionMaxTime"];
            $currMinProd = $row["ProductionMin"];
            $currMinProdTime = $row["ProductionMinTime"];
            $currMaxCons = $row["ConsumptionMax"];
            $currMaxConsTime = $row["ConsumptionMaxTime"];
            $currMinCons = $row["ConsumptionMin"];
            $currMinConsTime = $row["ConsumptionMinTime"];  
            $lastUpdated = $row["EnvoyMaxMinUpdateTimestamp"];
        }
    }
}
if($rowCount > 0)
{
    //$echoResponse["EnvoyDate"] = dateinDMY($envoyDateYYYYMMDD);
    $echoResponse["MaxProd"] = sprintf("%07.2f",$currMaxProd);
    $echoResponse["MaxProdTime"] = timeinHHMM($currMaxProdTime);
    $echoResponse["MinProd"] = sprintf("%07.2f",$currMinProd);
    $echoResponse["MinProdTime"] = timeinHHMM($currMinProdTime);
    $echoResponse["MaxCons"] = sprintf("%07.2f",$currMaxCons);
    $echoResponse["MaxConsTime"] = timeinHHMM($currMaxConsTime);
    $echoResponse["MinCons"] = sprintf("%07.2f",$currMinCons);
    $echoResponse["MinConsTime"] = timeinHHMM($currMinConsTime);
    $echoResponse["LastUpdated"] = dMYHi($lastUpdated);
}

global $telegramHourlyBotAPIToken;
$telegramMessage = "";
$telegramMessage =  "Envoy Last Hour Statistics".PHP_EOL.
                    "Reading Date Time : ".dMYHiFromEpoch($envoyDateEpoch).PHP_EOL.
                    "Prev. Hour Production : ".sprintf("%05.2f",$envoyProductionPrevHour)." kWh".PHP_EOL.
                    "Prev. Hour Consumption : ".sprintf("%05.2f",$envoyConsumptionPrevHour)." kWh".PHP_EOL.
                    "Today's Production : ".sprintf("%05.2f",$envoyProductionDayPrevHour)." kWh".PHP_EOL.
                    "Today's Consumption : ".sprintf("%05.2f",$envoyConsumptionDayPrevHour)." kWh".PHP_EOL;
if($rowCount > 0)
{
    $telegramMessage = $telegramMessage."**************************".PHP_EOL; 
    $telegramMessage = $telegramMessage."Max Solar Production At : ".messageDateTimeFromTimestamp($currMaxProdTime).PHP_EOL."Max Value : ".sprintf("%07.2f",$currMaxProd)." W".PHP_EOL;
    $telegramMessage = $telegramMessage."Min Solar Production At : ".messageDateTimeFromTimestamp($currMinProdTime).PHP_EOL."Min Value : ".sprintf("%07.2f",$currMinProd)." W".PHP_EOL;
    $telegramMessage = $telegramMessage."Max Consumption At : ".messageDateTimeFromTimestamp($currMaxConsTime).PHP_EOL."Max Value : ".sprintf("%07.2f",$currMaxCons)." W".PHP_EOL;
    $telegramMessage = $telegramMessage."Min Consumption At : ".messageDateTimeFromTimestamp($currMinConsTime).PHP_EOL."Min Value : ".sprintf("%07.2f",$currMinCons)." W".PHP_EOL; 
    $telegramMessage = $telegramMessage."**************************".PHP_EOL; 
}

if($maxProdPeriodStmt->execute())
{
    $result = $maxProdPeriodStmt->get_result();
    $rowCount = mysqli_num_rows($result);
    if($rowCount > 0)
    {
        while ($row = $result->fetch_assoc())
        {
            $envoyMaxProdPeriod = $row["EnvoyProdHour"];
            $prevMaxProdHour = $row["PrevHour"];
            $currMaxProdHour = $row["CurrHour"];
        }
        $echoResponse["MaxProdPerHour"] = sprintf("%05.2f",$envoyMaxProdPeriod);
        $echoResponse["MaxProdStartHour"] = $prevMaxProdHour;
        $echoResponse["MaxProdEndHour"] = $currMaxProdHour;
    }
}

if($minProdPeriodStmt->execute())
{
    $result = $minProdPeriodStmt->get_result();
    $rowCount = mysqli_num_rows($result);
    if($rowCount > 0)
    {
        while ($row = $result->fetch_assoc())
        {
            $envoyMinProdPeriod = $row["EnvoyProdHour"];
            $prevMinProdHour = $row["PrevHour"];
            $currMinProdHour = $row["CurrHour"];
        }
        $echoResponse["MinProdPerHour"] = sprintf("%05.2f",$envoyMinProdPeriod);
        $echoResponse["MinProdStartHour"] = $prevMinProdHour;
        $echoResponse["MinProdEndHour"] = $currMinProdHour;
    }
}

if($maxConsPeriodStmt->execute())
{
    $result = $maxConsPeriodStmt->get_result();
    $rowCount = mysqli_num_rows($result);
    if($rowCount > 0)
    {
        while ($row = $result->fetch_assoc())
        {
            $envoyMaxConsPeriod = $row["EnvoyConsHour"];
            $prevMaxConsHour = $row["PrevHour"];
            $currMaxConsHour = $row["CurrHour"];
        }
        $echoResponse["MaxConsPerHour"] = sprintf("%05.2f",$envoyMaxConsPeriod);
        $echoResponse["MaxConsStartHour"] = $prevMaxConsHour;
        $echoResponse["MaxConsEndHour"] = $currMaxConsHour;
    }
}

if($minConsPeriodStmt->execute())
{
    $result = $minConsPeriodStmt->get_result();
    $rowCount = mysqli_num_rows($result);
    if($rowCount > 0)
    {
        while ($row = $result->fetch_assoc())
        {
            $envoyMinConsPeriod = $row["EnvoyConsHour"];
            $prevMinConsHour = $row["PrevHour"];
            $currMinConsHour = $row["CurrHour"];
        }
        $echoResponse["MinConsPerHour"] = sprintf("%05.2f",$envoyMinConsPeriod);
        $echoResponse["MinConsStartHour"] = $prevMinConsHour;
        $echoResponse["MinConsEndHour"] = $currMinConsHour;
    }
}

if ($prevMaxProdHour != "")
    $telegramMessage = $telegramMessage."Max Hourly Production between ".$prevMaxProdHour." - ".$currMaxProdHour." : ".sprintf("%05.2f",$envoyMaxProdPeriod)." kWh".PHP_EOL;
if ($prevMinProdHour != "")
    $telegramMessage = $telegramMessage."Min Hourly Production between ".$prevMinProdHour." - ".$currMinProdHour." : ".sprintf("%05.2f",$envoyMinProdPeriod)." kWh".PHP_EOL;
if ($prevMaxConsHour != "")
    $telegramMessage = $telegramMessage."Max Hourly Consumption between ".$prevMaxConsHour." - ".$currMaxConsHour." : ".sprintf("%05.2f",$envoyMaxConsPeriod)." kWh".PHP_EOL;
if ($prevMinConsHour != "")
    $telegramMessage = $telegramMessage."Min Hourly Consumption between ".$prevMinConsHour." - ".$currMinConsHour." : ".sprintf("%05.2f",$envoyMinConsPeriod)." kWh".PHP_EOL;

$telegramMessage = $telegramMessage."**************************".PHP_EOL; 
global $telegramChatId;
global $telegramDadChatId;
sendTelegramMessageToBot($telegramChatId,$telegramHourlyBotAPIToken, $telegramMessage);
sendTelegramMessageToBot($telegramDadChatId,$telegramDadHourlyBotAPIToken, $telegramMessage);
closeConnection();
$echoResponse["trace"] = $traceMessage;
$echoResponse["processTime"] = round((hrtime(true) - $startTime)/1e+6,2)."ms";
echo json_encode($echoResponse);


?>